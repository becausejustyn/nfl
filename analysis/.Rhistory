mean_epa <- s$value[1]
lci <- s$value[3]
uci <- s$value[4]
df <- data.frame("mean" = mean_epa, "LCI" = lci, "UCI" = uci)
lst[[qb]] <- df
}
library(lme4)
library(plyr)
library(purrr)
library(dplyr)
library(ggplot2)
library(ggthemes)
library(RColorBrewer)
library(extrafont)
#loadfonts(device = "mac")
library(parallel)
set1 <- brewer.pal(n = 9, name = "Set1") #This is to see colour codes
pbp <- data
pbp_mut <- pbp %>%
dplyr::mutate(
def_coach = if_else(defteam == home_team, home_coach, away_coach),
pos_coach = if_else(posteam == home_team, home_coach, away_coach),
home = if_else(posteam == home_team, 1, 0),
wind = ifelse(is.na(wind) == T, min(wind, na.rm = T), wind),
temp = ifelse(is.na(temp) == T, 75, temp),
opponent = paste(season.x, defteam, sep = "_"),
team = paste(season.x, posteam, sep = "_"),
player_id = passer_id,
season = as.factor(season.x)
) %>%
dplyr::filter(
play_type == "pass",
game_type == "REG",
wp >= .20,
wp <= .80,
game_half != "Overtime",
season.x > 2005
) %>%
select(epa, temp, wind, home, season, player_id, pos_coach, def_coach, team, opponent, wp)
pbp_mut <- pbp %>%
dplyr::mutate(
def_coach = if_else(defteam == home_team, home_coach, away_coach),
pos_coach = if_else(posteam == home_team, home_coach, away_coach),
home = if_else(posteam == home_team, 1, 0),
wind = ifelse(is.na(wind) == T, min(wind, na.rm = T), wind),
temp = ifelse(is.na(temp) == T, 75, temp),
opponent = paste(season.x, defteam, sep = "_"),
team = paste(season.x, posteam, sep = "_"),
player_id = passer_id,
season = as.factor(season.x)
) %>%
dplyr::filter(
play_type == "pass",
game_type == "REG",
wp >= .20,
wp <= .80,
game_half != "Overtime",
season > 2005
) %>%
select(epa, temp, wind, home, season, player_id, pos_coach, def_coach, team, opponent, wp)
pbp_mut <- pbp %>%
dplyr::mutate(
def_coach = if_else(defteam == home_team, home_coach, away_coach),
pos_coach = if_else(posteam == home_team, home_coach, away_coach),
home = if_else(posteam == home_team, 1, 0),
wind = ifelse(is.na(wind) == T, min(wind, na.rm = T), wind),
temp = ifelse(is.na(temp) == T, 75, temp),
opponent = paste(season.x, defteam, sep = "_"),
team = paste(season, posteam, sep = "_"),
player_id = passer_id,
season = as.factor(season.x)
) %>%
dplyr::filter(
play_type == "pass",
game_type == "REG",
wp >= .20,
wp <= .80,
game_half != "Overtime",
season > 2005
) %>%
select(epa, temp, wind, home, season, player_id, pos_coach, def_coach, team, opponent, wp)
pbp_mut <- pbp %>%
dplyr::mutate(
def_coach = if_else(defteam == home_team, home_coach, away_coach),
pos_coach = if_else(posteam == home_team, home_coach, away_coach),
home = if_else(posteam == home_team, 1, 0),
wind = ifelse(is.na(wind) == T, min(wind, na.rm = T), wind),
temp = ifelse(is.na(temp) == T, 75, temp),
opponent = paste(season, defteam, sep = "_"),
team = paste(season, posteam, sep = "_"),
player_id = passer_id,
season = as.factor(season)
) %>%
dplyr::filter(
play_type == "pass",
game_type == "REG",
wp >= .20,
wp <= .80,
game_half != "Overtime",
season > 2005
) %>%
select(epa, temp, wind, home, season, player_id, pos_coach, def_coach, team, opponent, wp)
pbp %>% head
pbp_mut <- pbp %>%
dplyr::mutate(
def_coach = if_else(defteam == home_team, home_coach, away_coach),
pos_coach = if_else(posteam == home_team, home_coach, away_coach),
home = if_else(posteam == home_team, 1, 0),
wind = ifelse(is.na(wind) == T, min(wind, na.rm = T), wind),
temp = ifelse(is.na(temp) == T, 75, temp),
opponent = paste(season, defteam, sep = "_"),
team = paste(season, posteam, sep = "_"),
player_id = passer_id,
season = as.factor(season)
) %>%
dplyr::filter(
play_type == "pass",
season_type == "REG",
wp >= .20,
wp <= .80,
game_half != "Overtime",
season > 2005
) %>%
select(epa, temp, wind, home, season, player_id, pos_coach, def_coach, team, opponent, wp)
pbp_mut <- pbp %>%
dplyr::mutate(
def_coach = if_else(defteam == home_team, home_coach, away_coach),
pos_coach = if_else(posteam == home_team, home_coach, away_coach),
home = if_else(posteam == home_team, 1, 0),
wind = ifelse(is.na(wind) == T, min(wind, na.rm = T), wind),
temp = ifelse(is.na(temp) == T, 75, temp),
opponent = paste(season, defteam, sep = "_"),
team = paste(season, posteam, sep = "_"),
player_id = passer_id,
season = as.factor(season)
) %>%
dplyr::filter(
play_type == "pass",
season_type == "REG",
wp >= .20,
wp <= .80,
game_half != "Overtime"
) %>%
select(epa, temp, wind, home, season, player_id, pos_coach, def_coach, team, opponent, wp)
pbp_mut
# Mixed model
mixed_model <- pbp_mut %>%
lmer(
formula =
epa ~
temp +
wind +
home +
wp +
as.factor(season) +
(1 | player_id) +
(1 | pos_coach) +
(1 | team) +
(1 | def_coach) +
(1 | opponent),
control = lmerControl(
optimizer = "bobyqa",
optCtrl = list(maxfun = 2e5)
)
)
# Summary
mixed_model %>% summary()
getME(mixed_model, "theta") # Research Cholesky factors | try ?getME
fixef(mixed_model)
pbp
pbp <- purrr::map_df(c(2021), function(x) {
readRDS(
glue::glue("~/Documents/nfl/data/pbp/play_by_play_{x}.rds")
)
})
data <- pbp
filt = data %>% filter(
season_type == 'REG',
!play_type %in% c('no_play','qb_spike','qb_kneel'),
!is.na(play_type),
!is.na(epa)
)
offense = filt %>%
group_by(
game_id, posteam) %>%
summarise(
EPA = sum(epa),
home = unique(home_team),
away = unique(away_team)
) %>%
ungroup()
defense = filt %>%
group_by(
game_id, defteam) %>%
summarise(
DefEPA = sum(epa)
) %>%
ungroup()
filt %>%
group_by(
game_id, posteam) %>%
summarise(
EPA = sum(epa),
home = unique(home_team),
away = unique(away_team)
)
filt %>% count(home_team)
filt
count(filt, home_team)
data <- purrr::map_df(c(2021), function(x) {
readRDS(
glue::glue("~/Documents/nfl/data/pbp/play_by_play_{x}.rds")
)
data <- purrr::map_df(c(2021), function(x) {
readRDS(
glue::glue("~/Documents/nfl/data/pbp/play_by_play_{x}.rds")
)})
data %>%
filter(
season_type == 'REG',
!play_type %in% c('no_play','qb_spike','qb_kneel'),
!is.na(play_type),
!is.na(epa)
)
filt = data %>%
filter(
season_type == 'REG',
!play_type %in% c('no_play','qb_spike','qb_kneel'),
!is.na(play_type),
!is.na(epa)
)
filt %>%
group_by(
game_id, posteam) %>%
summarise(
EPA = sum(epa),
home = unique(home_team),
away = unique(away_team)
)
gc()
library(tidyverse)
<<<<<<< Updated upstream
nfl_elo_latest <- read_csv("~/Downloads/new_archives/nfl-elo/nfl_elo_latest.csv")
games <- nfl_elo_latest %>%
select(date,
neutral,
home = team1,
away = team2,
h_score = score1,
a_score = score2) %>%
mutate(h_mov = h_score - a_score)
current_season <- pull(nfl_elo_latest, season) %>% max()
glue("There was {games %>% nrow} games played in {current_season}. {pull(games, neutral) %>% sum()} of those games were played on a neutral field.")
glue::glue("There was {games %>% nrow} games played in {current_season}. {pull(games, neutral) %>% sum()} of those games were played on a neutral field.")
teams <- distinct(games, home) %>%
arrange(home) %>%
pull()
teams %>% length() == 32
=======
data <- purrr::map_df(c(2021), function(x) {
readRDS(
glue::glue("~/Documents/nfl/data/pbp/play_by_play_{x}.rds")
)})
filt = data %>%
filter(
season_type == 'REG',
!play_type %in% c('no_play','qb_spike','qb_kneel'),
!is.na(play_type),
!is.na(epa)
)
offense = filt %>%
group_by(
game_id, posteam) %>%
summarise(
EPA = sum(epa),
home = unique(home_team),
away = unique(away_team)
) %>%
ungroup()
defense = filt %>%
group_by(
game_id, defteam) %>%
summarise(
DefEPA = sum(epa)
) %>%
ungroup()
team = dplyr::inner_join(
offense,defense, by = c("game_id" = "game_id", "posteam" = "defteam")
) %>%
rename(
team = posteam
)%>%
mutate(
EPADiff = EPA - DefEPA,
opponent = if_else(team == home, away,home)
) %>%
select(team,opponent,home,EPADiff) %>% arrange(by=team)
model = team %>%
lme4::lmer(
formula=
# Response variable
EPADiff ~
#adjust for opponent
as.factor(opponent) +
#this is the strength of each team
(1|team)
)
effects = broom.mixed::tidy(model,effects="ran_vals") %>%
filter(group == 'team') %>%
select(level,estimate,std.error) %>% rename(team = level) %>%
arrange(
by = estimate
) %>%
mutate(
rank = 32:1,
Team = paste(team,rank)
)
z <- 1.96
effects %>%
ggplot(aes(x=factor(Team, level = Team),estimate)) +
geom_linerange(alpha = .7, color = 'gray', linetype = 2,aes(ymin=estimate - z*std.error,
ymax=estimate + z*std.error))+
geom_point(aes(fill = estimate),alpha = 1, color='gray',pch=21,size=3) +
coord_flip() + ggdark::dark_theme_classic() +
theme(
axis.title.y = element_blank(),
plot.title = element_text(hjust = 0.5),
plot.subtitle = element_text(hjust = 0.5),
legend.position = 'none'
) +
labs(y = "EPA Difference",
caption = "Data: nflfastR, by  @adriancm93",
title = "Power Rankings",
subtitle = paste0(
unique(filt$season),' season, weeks ',min(filt$week),'-',max(filt$week), ', adjusted for opponent')
)
install.packages("ggdark")
styler:::style_selection()
styler:::style_selection()
effects %>%
ggplot(aes(x = factor(Team, level = Team), estimate)) +
geom_linerange(alpha = .7, color = "gray", linetype = 2, aes(
ymin = estimate - z * std.error,
ymax = estimate + z * std.error
)) +
geom_point(aes(fill = estimate), alpha = 1, color = "gray", pch = 21, size = 3) +
coord_flip() +
ggdark::dark_theme_classic() +
theme(
axis.title.y = element_blank(),
plot.title = element_text(hjust = 0.5),
plot.subtitle = element_text(hjust = 0.5),
legend.position = "none"
) +
labs(
y = "EPA Difference",
caption = "Data: nflfastR, by  @adriancm93",
title = "Power Rankings",
subtitle = paste0(
unique(filt$season), " season, weeks ", min(filt$week), "-", max(filt$week), ", adjusted for opponent"
)
)
library(readr)
spreadspoke_scores <- read_csv("~/Downloads/archive/spreadspoke_scores.csv")
View(spreadspoke_scores)
nfl <- read_excel("~/Downloads/nfl.xlsx")
gc()
pbp <- purrr::map_df(c(2001:2021), function(x) {
readRDS(
glue::glue("~/Documents/nfl/data/pbp/play_by_play_{x}.rds")
)})
pbp1 <- filter(pbp, season == 2021)
pbp1 %>% distinct(week)
pbp1 %>% filter(season_type == 'REG') %>% distinct(week)
outcomes <- pbp1 %>%
filter(season_type == 'REG') %>%
group_by(season, game_id, home_team) %>%
summarize(
home_win = if_else(sum(result) > 0, 1, 0),
home_tie = if_else(sum(result) == 0, 1, 0),
home_diff = last(result),
home_pts_for = last(home_score),
home_pts_against = last(away_score)
) %>%
group_by(season, home_team) %>%
summarize(
home_games = n(),
home_wins = sum(home_win),
home_ties = sum(home_tie),
home_diff = sum(home_diff),
home_pts_for = sum(home_pts_for),
home_pts_against = sum(home_pts_against)
) %>%
ungroup() %>%
left_join(
# away games
pbp1 %>%
filter(season_type == 'REG') %>%
group_by(season, game_id, away_team) %>%
summarize(
away_win = if_else(sum(result) < 0, 1, 0),
away_tie = if_else(sum(result) == 0, 1, 0),
away_diff = last(result)*-1,
away_pts_for = last(away_score),
away_pts_against = last(home_score)
) %>%
group_by(season, away_team) %>%
summarize(
away_games = n(),
away_wins = sum(away_win),
away_ties = sum(away_tie),
away_diff = sum(away_diff),
away_pts_for = sum(away_pts_for),
away_pts_against = sum(away_pts_against)
) %>%
ungroup(),
by = c("season", "home_team" = "away_team")
) %>%
rename(team = "home_team") %>%
mutate(
games = home_games + away_games,
wins = home_wins + away_wins,
losses = games - wins,
ties = home_ties + away_ties,
win_percentage = (wins + 0.5 * ties) / games,
point_diff = home_diff + away_diff,
points_for = home_pts_for + away_pts_for,
points_against = home_pts_against + away_pts_against,
pythag_wins = (points_for^2.37 / (points_for^2.37 + points_against^2.37))*16
) %>%
select(
season, team, games, wins, losses, ties, win_percentage, point_diff, points_for, points_against, pythag_wins
)
outcomes
outcomes1 <- pbp1 %>%
filter(season_type == 'REG') %>%
group_by(season, game_id, home_team) %>%
summarize(
home_win = if_else(sum(result) > 0, 1, 0),
home_tie = if_else(sum(result) == 0, 1, 0),
home_diff = last(result),
home_pts_for = last(home_score),
home_pts_against = last(away_score)
) %>%
group_by(season, home_team) %>%
summarize(
home_games = n(),
home_wins = sum(home_win),
home_ties = sum(home_tie),
home_diff = sum(home_diff),
home_pts_for = sum(home_pts_for),
home_pts_against = sum(home_pts_against)
) %>%
ungroup()
outcomes1
pbp1 %>%
filter(season_type == 'REG') %>%
group_by(season, game_id, home_team) %>%
summarize(
home_win = if_else(sum(result) > 0, 1, 0),
home_tie = if_else(sum(result) == 0, 1, 0),
home_diff = last(result),
home_pts_for = last(home_score),
home_pts_against = last(away_score)
)
pbp %>% count(stadium)
pbp %>% count(roof)
pbp1 %>%
filter(season_type == 'REG') %>%
group_by(season, game_id, home_team) %>%
summarize(
home_win = if_else(sum(result) > 0, 1, 0),
home_tie = if_else(sum(result) == 0, 1, 0),
home_diff = last(result),
home_pts_for = last(home_score),
home_pts_against = last(away_score)
) %>%
group_by(season, home_team, roof) %>%
summarize(
home_games = n(),
home_wins = sum(home_win),
home_ties = sum(home_tie),
home_diff = sum(home_diff),
home_pts_for = sum(home_pts_for),
home_pts_against = sum(home_pts_against)
) %>%
ungroup()
pbp1 %>%
filter(season_type == 'REG') %>%
group_by(season, game_id, home_team, roof) %>%
summarize(
home_win = if_else(sum(result) > 0, 1, 0),
home_tie = if_else(sum(result) == 0, 1, 0),
home_diff = last(result),
home_pts_for = last(home_score),
home_pts_against = last(away_score)
) %>%
group_by(season, home_team) %>%
summarize(
home_games = n(),
home_wins = sum(home_win),
home_ties = sum(home_tie),
home_diff = sum(home_diff),
home_pts_for = sum(home_pts_for),
home_pts_against = sum(home_pts_against)
) %>%
ungroup()
pbp1 %>%
filter(season_type == 'REG') %>%
group_by(season, game_id, home_team, roof) %>%
summarize(
home_win = if_else(sum(result) > 0, 1, 0),
home_tie = if_else(sum(result) == 0, 1, 0),
home_diff = last(result),
home_pts_for = last(home_score),
home_pts_against = last(away_score)
) %>%
group_by(season, home_team, roof) %>%
summarize(
home_games = n(),
home_wins = sum(home_win),
home_ties = sum(home_tie),
home_diff = sum(home_diff),
home_pts_for = sum(home_pts_for),
home_pts_against = sum(home_pts_against)
) %>%
ungroup()
pbp1 %>% count(roof)
pbp %>% count(roof)
outcomes
>>>>>>> Stashed changes
