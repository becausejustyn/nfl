library(tidyverse)
library(alabama)
nfl_scores_url <- 'https://projects.fivethirtyeight.com/nfl-api/2017/nfl_games_2017.csv'
nfl <- read_csv(nfl_scores_url)
nfl
nfl_scores_url <- 'https://projects.fivethirtyeight.com/nfl-api/2021/nfl_games_2021.csv'
nfl <- read_csv(nfl_scores_url)
games <- nfl %>%  # remove future games
select(date,
neutral,
home = team1,
away = team2,
h_score = score1,
a_score = score2) %>%
mutate(h_mov = h_score - a_score)
paste("There was",
nrow(games),
"games played in 2021.",
sum(games$neutral),
"of those games were played on a neutral field.")
4/285
home_forecast <- function(home_rating, visitor_rating, home_edge) {
(home_edge + home_rating) - visitor_rating
}
teams <- sort(unique(games$home))
length(teams) == 32 # there's 32 NFL teams
ratings <- rep(0,33)
names(ratings) <- c(teams, 'hfa') # hfa = home field advantage
sqr_err <- function(ratings) {
games %>%
mutate(forecast = home_forecast(
ratings[home],
ratings[away],
ratings[33]
)) %>% # 33 is the hfa
mutate(resid = (h_mov - forecast)^2) %>%
summarise(sse = sum(resid)) %>%
pull(sse)
}
set_team_avg_zero <- function(ratings) {
h <- rep(NA, 1)
h[1] <- mean(ratings[-33])
h
}
set_team_avg_zero(ratings)
mod <- constrOptim.nl(
par = ratings,
fn = sqr_err,
heq = set_team_avg_zero
)
mod <- constrOptim.nl(
par = ratings,
fn = sqr_err,
heq = set_team_avg_zero
)
set_team_avg_zero(ratings)
mod <- constrOptim.nl(
par = ratings,
fn = sqr_err,
heq = set_team_avg_zero
)
ratings
set_team_avg_zero
sqr_err <- function(ratings) {
games %>%
mutate(forecast = home_forecast(
ratings[home],
ratings[away],
ratings[33]
)) %>% # 33 is the hfa
mutate(resid = (h_mov - forecast)^2) %>%
summarise(sse = sum(resid)) %>%
pull(sse)
}
games <- nfl %>%  # remove future games
select(date,
neutral,
home = team1,
away = team2,
h_score = score1,
a_score = score2) %>%
mutate(h_mov = h_score - a_score)
games
home_forecast <- function(home_rating, visitor_rating, home_edge) {
(home_edge + home_rating) - visitor_rating
}
teams <- sort(unique(games$home))
length(teams) == 32 # there's 32 NFL teams
teams
ratings <- rep(0,33)
names(ratings) <- c(teams, 'hfa') # hfa = home field advantage
sqr_err <- function(ratings) {
games %>%
mutate(forecast = home_forecast(
ratings[home],
ratings[away],
ratings[33]
)) %>% # 33 is the hfa
mutate(resid = (h_mov - forecast)^2) %>%
summarise(sse = sum(resid)) %>%
pull(sse)
}
set_team_avg_zero <- function(ratings) {
h <- rep(NA, 1)
h[1] <- mean(ratings[-33])
h
}
set_team_avg_zero(ratings)
mod <- constrOptim.nl(
par = ratings,
fn = sqr_err,
heq = set_team_avg_zero
)
sse_ratings <- mod$par
?constrOptim.nl
library(tidyverse)
nfl_elo_latest <- read_csv("~/Downloads/new_archives/nfl-elo/nfl_elo_latest.csv")
games <- nfl_elo_latest %>%
select(date,
neutral,
home = team1,
away = team2,
h_score = score1,
a_score = score2) %>%
mutate(h_mov = h_score - a_score)
current_season <- pull(nfl_elo_latest, season) %>% max()
glue("There was {games %>% nrow} games played in {current_season}. {pull(games, neutral) %>% sum()} of those games were played on a neutral field.")
glue::glue("There was {games %>% nrow} games played in {current_season}. {pull(games, neutral) %>% sum()} of those games were played on a neutral field.")
teams <- distinct(games, home) %>%
arrange(home) %>%
pull()
teams %>% length() == 32
