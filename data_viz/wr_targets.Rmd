---
title: "R Notebook"
output: html_notebook
---


# Targeted Receiver Data

This notebook is a demo of Targeted Receiver data. It gives the targetted receiver for each gameId and playId in the data. `targetNflId` maps to `nflId` in the `players.csv` and `week[x].csv` files.

The `targetNflId` column is missing if there the ball is thrown away, spiked or if there is no clear target on the play.

## Loading Libraries

```{r}
library(tidyverse)
library(repr)
library(tm)
library(ggrepel)

#turning off warnings
options(warn = -1)

#setting plot width and height
options(repr.plot.width = 15, repr.plot.height = 10)
```

```{r}
#reading data

#includes play-by-play info on specific plays
df_plays <- read_csv("Downloads/big_data_bowl_data/plays.csv", col_types = cols())

#includes background info for players
df_players <- read_csv("Downloads/big_data_bowl_data/players.csv", col_types = cols())

#includes targetted receiver by play
df_targetedReceiver <- read_csv("Downloads/big_data_bowl_data/targetedReceiver.csv", col_types = cols())
```

### Viz
```{r}
# merging receiver data to players data

inner_join(df_targetedReceiver, df_players, by = c("targetNflId" = "nflId")) %>%
  group_by(displayName) %>%
  #counting number of targets
  summarise(targets = n()) %>%
  #ungrouping
  ungroup() %>%
  #sorting by most to least targets
  arrange(-targets) %>%
  #filtering those outside of top 25
  filter(row_number() <= 25) %>%
  ggplot(aes(
    reorder(displayName, targets),
    targets)) +
    geom_bar(stat = 'identity', color = 'blue', fill = 'lightblue') +
    theme_bw() +
    theme(text = element_text(size = 22)) +
  labs(
    x = '',
    y = 'Number of Targets',
    title = 'Top 25 in Number of Targets by Player'
  ) +
    coord_flip()
```

Another metric of interest is who is being targetted on various downs. This visualization will be similar to the one above, but split by Down.

```{r}
#merging receiver data to players daa
inner_join(df_targetedReceiver, df_players, by = c("targetNflId" = "nflId")) %>%
#mering plays data
  inner_join(df_plays, by = c("gameId" = "gameId", "playId" = "playId")) %>%
  #grouping by name and down
  group_by(displayName, down) %>%
  #counting number of targets
  summarise(targets = n()) %>%
  ungroup() %>%
  #grouping by down only so to filter top 10 by down
  group_by(down) %>% 
  arrange(-targets) %>%
  #filtering those outside of top 10
  filter(row_number() <= 10) %>%
  ungroup() %>%
  #Needed to properly order the bars
  mutate(displayName = paste0(down, displayName)) %>%
  ggplot(aes(
    reorder(displayName, targets),
    targets)) +
    geom_bar(stat = 'identity', color = 'blue', fill = 'lightblue') +
    theme_bw() +
    theme(text = element_text(size=22)) +
  labs(
    x = '', 
    y = 'Number of Targets',
    title = 'Top 10 in Number of Targets by Player, Faceted by Down'
  ) +
    coord_flip() +
    #faceting by Down
    facet_wrap(~down, scales = 'free') +
    #fixing display name
    scale_x_discrete(labels = removeNumbers)
```

Finally, we explore the relationship between targets and number of DPIs drawn.

```{r}
inner_join(df_targetedReceiver, df_players,  by = c("targetNflId" = "nflId")) %>%
  inner_join(df_plays, by = c("gameId" = "gameId", "playId" = "playId")) %>%
  group_by(displayName) %>%
  summarise(
    targets = n(),
    dpisDrawn = sum(grepl('DPI', penaltyCodes))
    ) %>%
  ungroup() %>%
  mutate(
    label_text = ifelse((dpisDrawn >= 7.5) | (dpisDrawn <=1.25 & targets > 150) | (dpisDrawn > 5.1 & targets < 100), displayName, '')
    ) %>%
  ggplot(aes(
    targets,
    dpisDrawn)) +
  geom_point() +
  geom_smooth(method = 'lm', equation = y ~ x) +
  theme_bw() +
  theme(text = element_text(size=22)) +
  labs(
    x = 'Targets',
    y = 'DPIs Drawn',
    title = 'DPIs Drawn vs Targets'
  ) + 
  geom_text_repel(aes(label = label_text), size = 8)

```