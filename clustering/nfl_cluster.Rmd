---
title: "R Notebook"
output: 
  html_document: 
    self_contained: no
---

NFL Clustering


Clustering

```{r}
library(tidyverse)
library(ggrepel)
library(ggimage)
library(nflfastR)
library(stats)
library(mclust)
library(mdthemes)
library(gghighlight)
library(na.tools)
library(gghighlight)
library(becausejustynfun)
```

```{r}
pbp <- purrr::map_df(2021, function(x) {
  readRDS(
      glue::glue("~/Documents/nfl/data/pbp/play_by_play_{x}.rds")
    )
})
```

```{r}
pbp_rp <- pbp %>% 
  filter(pass == 1 | rush == 1) %>%
  add_xpass() %>%
  filter(!is.na(pass_oe)) %>%
  mutate(
    outside_run = ifelse(run_gap == "end", 1, 0),
    inside_run = ifelse(!run_gap == "end", 1, 0),
    yards_past_sticks = air_yards - ydstogo
  )
```


```{r}
pbp_rp <- pbp %>%
  filter(!is.na(epa), play_type %in% c("no_play", "pass", "run")) %>%
  mutate(
    pass = if_else(str_detect(desc, "( pass)|(sacked)|(scramble)"), 1, 0),
    rush = if_else(str_detect(desc, "(left end)|(left tackle)|(left guard)|(up the middle)|(right guard)|(right tackle)|(right end)") & pass == 0, 1, 0),
    success = ifelse(epa > 0, 1, 0)
  ) %>%
  filter(pass == 1 | rush == 1) %>%
  add_xpass() %>%
  filter(!is.na(pass_oe)) %>%
  mutate(
    outside_run = ifelse(run_gap == "end", 1, 0),
    inside_run = ifelse(run_gap != "end", 1, 0),
    yards_past_sticks = air_yards - ydstogo
  )
```

```{r}
team_stats <- pbp_rp %>%
  group_by(posteam) %>%
  summarise(
    plays = n(),
    proe_avg = mean(pass_oe, na.rm = TRUE),
    outside_run_rate = mean(outside_run, na.rm = TRUE),
    inside_run_rate = mean(inside_run, na.rm = TRUE),
    yards_per_attempt = mean(air_yards, na.rm = TRUE),
    yac_avg = mean(yards_after_catch, na.rm = TRUE),
    qb_scramble_rate = mean(qb_scramble, na.rm = TRUE),
    qb_hit_rate = mean(qb_hit, na.rm = TRUE),
    qb_sack_rate = mean(sack, na.rm = TRUE),
    first_down_pass_rate = mean(first_down_pass, na.rm = TRUE),
    yards_over_sticks = mean(yards_past_sticks, na.rm = TRUE)
  )
```

```{r}
library(tidymodels)

team_stats_clust <- team_stats %>%
  mutate(across(proe_avg:yards_over_sticks, ~ as.numeric(scale(.))))

kclusts <- tibble(k = 1:9) %>%
  mutate(
    kclust = purrr::map(k, ~ kmeans(select(team_stats_clust, -c(plays, posteam)), .x)),
    glanced = purrr::map(kclust, glance),
  )

kclusts %>%
  unnest(cols = c(glanced)) %>%
  ggplot(aes(k, tot.withinss)) +
  geom_line(alpha = 0.5, size = 1.2, color = "midnightblue") +
  geom_point(size = 2, color = "midnightblue") +
  scale_x_continuous(breaks = seq(1, 9, 1))
```


```{r}
rolling_see_difference <- function(x, n = 2){
  x - n * lead(x) + lead(x, n)
}

kclusts %>%
  unnest(cols = c(glanced)) %>%
  mutate(
    sse_difference = rolling_see_difference(tot.withinss)
  ) %>%
  ggplot(aes(
    x = k, 
    y = sse_difference)) +
    geom_line(alpha = 0.5, size = 1.2, color = "midnightblue") +
    geom_point(size = 2, color = "midnightblue") +
    scale_x_continuous(breaks = seq(1, 9, 1)) +
    labs(
      x = "k",
      y = "SSE Rolling 2-Unit Difference"
    )
```

```{r}
#It levels off at 6 K's
set.seed(2017)
final_clust <- kmeans(select(team_stats_clust, -c(plays, posteam)), centers = 5)

clust_cen <- final_clust %>% augment(team_stats_clust) 
#paste0("Cluster ", c(1:5)) 

```

```{r}
clust_cen_wide <- clust_cen %>%
  rename(
    PROE = proe_avg,
    ORR = outside_run_rate, 
    IRR = inside_run_rate, 
    YPA = yards_per_attempt, 
    YAC = yac_avg, 
    QBSR = qb_scramble_rate, 
    QBHR = qb_hit_rate, 
    SaR = qb_sack_rate, 
    FDPR = first_down_pass_rate, 
    YPS = yards_over_sticks
  ) %>%
  select(-c(plays, posteam)) %>%
  pivot_longer(!.cluster, names_to = 'feature', values_to = 'z_val')
```

```{r}
clust_cen_wide <- clust_cen_wide %>%
  mutate(
    feature = as_factor(feature)
  )

team_cluster <- clust_cen %>%
  select(posteam, .cluster) %>%
  left_join(teams_colors_logos, by = c("posteam" = "team_abbr"))
```

```{r}
clust_cen_wide %>%
  ggplot(aes(
    x = feature, 
    y = z_val, 
    colour = .cluster)) +
  geom_point(size = 3) +
  scale_color_brewer(palette = "Set1") +
  gghighlight(use_direct_label = FALSE) +
  facet_wrap(~.cluster, ncol = 3) +
  labs(
    x = "Feature", 
    y = "Cluster Center",
    title = "Each Cluster's Features"
  ) +
  white_theme() +
  theme(
    legend.position = "none", strip.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 90, size = 8),
    panel.grid.minor = element_blank()
  )
```


```{r}
off_epa <- pbp_rp %>%
  group_by(posteam) %>%
  summarise(epa_epa_play = mean(epa, na.rm = TRUE))

clust_cen_plot <- clust_cen %>%
  left_join(off_epa) %>%
  left_join(nflfastR::teams_colors_logos, by = c("posteam" = "team_abbr"))

clust_plot <- clust_cen_plot %>%
  ggplot(aes(
    x = .cluster,
    y = epa_epa_play
  )) +
  geom_image(aes(image = team_logo_espn), size = 0.05, asp = 16 / 9, position = position_jitter(width = 0, height = 0.6, seed = 123)) +
  #geom_image(aes(image = team_logo_espn), size = 0.05, asp = 16 / 9, position = "jitter") +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) +
  labs(
    x = "Cluster", 
    y = "Cluster's Average Offensive EPA/Play",
    title = 'The Average Offensive EPA/Play of Each Cluster',
    subtitle = "Cluster analysis of offensive schemes for all 32 NFL",
    caption = "Data: nflfastR") + 
  white_theme()
```

```{r}
clust_plot
```







