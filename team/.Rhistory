face = 'bold'
)
)
p2 <- ngs_total_p2 %>%
ggplot(aes(x = 1:nrow(ngs_total_p2), y = avg_yac_above_expectation)) +
geom_col(aes(
colour = team_color, fill = team_color,
width = percent_share_of_intended_air_yards / 60),
alpha = 0.4
) +
geom_text(
aes(label = player_display_name, y = avg_yac_above_expectation + 0.05),
angle = 90,
hjust = 0
) +
scale_size("Number of Targets") +
scale_color_identity(aesthetics = c('fill', 'colour')) +
labs(
x = "Rank",
y = "Average Yards after Catch above Expectation",
caption = "Data: @NextGenStats",
subtitle = "Top 32 Receivers (WR+TE) in Average Yards after Catch above Expectation (Column Width Corresponds to Target Share)"
) +
ylim(NA, 5.7) +
ggthemes::theme_stata(scheme = "sj", base_size = 10) +
theme(
plot.title = element_text(face = 'bold'),
plot.caption = element_text(hjust = 1),
axis.text.y = element_text(angle = 0, vjust = 0.5),
legend.title = element_text(
size = 10,
hjust = 0,
vjust = 0.5,
face = 'bold'
)
)
plot <- gridExtra::grid.arrange(p1, p2, nrow = 2)
plot
library(tidyverse)
library(nflfastR)
library(tidyverse)
library(nflfastR)
pbp <- purrr::map_df(2021, function(x) {
read_rds(
glue::glue("~/Documents/nfl/data/pbp/play_by_play_{x}.rds")
)
})
rosters <- purrr::map_df(2021, function(x) {
read_rds(
glue::glue("~/Documents/nfl/data/roster/roster_{x}.rds")
)
})
# compute cpoe grouped by air_yards
cpoe <- pbp %>%
filter(!is.na(cpoe)) %>%
group_by(passer_player_id, air_yards) %>%
summarise(
count = n(),
cpoe = mean(cpoe))
roster %>% names
rosters %>% names
rosters %>% select(full_name) %>% head()
summary <- pbp %>%
filter(!is.na(cpoe)) %>%
group_by(passer_player_id) %>%
summarise(plays = n()) %>%
arrange(desc(plays)) %>%
head(30) %>%
left_join(
rosters %>% select(full_name, gsis_id, team, headshot_url),
by = c("passer_player_id" = "gsis_id")
) %>%
mutate(# some headshot urls are broken. They are checked here and set to a default
headshot_url = dplyr::if_else(
RCurl::url.exists(as.character(headshot_url)),
as.character(headshot_url),
"http://static.nfl.com/static/content/public/image/fantasy/transparent/200x200/default.png",
)
) %>%
left_join(cpoe, by = "passer_player_id") %>%
left_join(
teams_colors_logos %>% select(team_abbr, team_color, team_logo_espn),
by = c("team.abbr" = "team_abbr")
)
summary <- pbp %>%
filter(!is.na(cpoe)) %>%
group_by(passer_player_id) %>%
summarise(plays = n()) %>%
arrange(desc(plays)) %>%
head(30) %>%
left_join(
rosters %>% select(full_name, gsis_id, team, headshot_url),
by = c("passer_player_id" = "gsis_id")
) %>%
mutate(# some headshot urls are broken. They are checked here and set to a default
headshot_url = dplyr::if_else(
RCurl::url.exists(as.character(headshot_url)),
as.character(headshot_url),
"http://static.nfl.com/static/content/public/image/fantasy/transparent/200x200/default.png",
)
) %>%
left_join(cpoe, by = "passer_player_id") %>%
left_join(
teams_colors_logos %>% select(team_abbr, team_color, team_logo_espn),
by = c("team_abbr" = "team_abbr")
)
summary <- pbp %>%
filter(!is.na(cpoe)) %>%
group_by(passer_player_id) %>%
summarise(plays = n()) %>%
arrange(desc(plays)) %>%
head(30) %>%
left_join(
rosters %>% select(full_name, gsis_id, team, headshot_url),
by = c("passer_player_id" = "gsis_id")
) %>%
mutate(# some headshot urls are broken. They are checked here and set to a default
headshot_url = dplyr::if_else(
RCurl::url.exists(as.character(headshot_url)),
as.character(headshot_url),
"http://static.nfl.com/static/content/public/image/fantasy/transparent/200x200/default.png",
)
) %>%
left_join(cpoe, by = "passer_player_id")
summary
summary %>%
left_join(
teams_colors_logos %>% select(team_abbr, team_color, team_logo_espn),
by = c("team" = "team_abbr")
)
summary <- summary %>%
left_join(
teams_colors_logos %>% select(team_abbr, team_color, team_logo_espn),
by = c("team" = "team_abbr")
)
summary
colors_raw <- summary %>%
group_by(passer_player_id) %>%
summarise(
team_label = first(team),
name = first(full_name)) %>%
left_join(
teams_colors_logos %>% select(team_abbr, team_color),
by = c("team" = "team_abbr")
) %>%
arrange(name)
summary %>%
group_by(passer_player_id) %>%
summarise(
team_label = first(team),
name = first(full_name))
colors_raw <- summary %>%
group_by(passer_player_id) %>%
summarise(
team_label = first(team),
name = first(full_name)) %>%
left_join(
teams_colors_logos %>% select(team_abbr, team_color),
by = c("team_label" = "team_abbr")
) %>%
arrange(name)
n_eval <- 80
colors <- as.data.frame(lapply(colors_raw, rep, n_eval)) %>%
arrange(name)
mean <- summary %>%
group_by(air_yards) %>%
summarise(
league = mean(cpoe),
league_count = n())
summary %>%
ggplot(aes(x = air_yards, y = cpoe)) +
geom_smooth(
data = mean, aes(x = air_yards, y = league, weight = league_count), n = n_eval,
color = "red", alpha = 0.7, se = FALSE, size = 0.5, linetype = "dashed"
) +
geom_smooth(
se = FALSE, alpha = 0.7, aes(weight = count), size = 0.65,
color = colors$team_color, n = n_eval
) +
geom_point(color = summary$team_color, size = summary$count / 15, alpha = 0.4) +
ggimage::geom_image(aes(x = 27.5, y = -20, image = team_logo_espn),
size = .15, by = "width", asp = asp
) +
ggimage::geom_image(aes(x = -2.5, y = -20, image = teamPlayers.headshot_url),
size = .15, by = "width", asp = asp
) +
xlim(-10, 40) + # makes sure the smoothing algorithm is evaluated between -10 and 40
coord_cartesian(xlim = c(-5, 30), ylim = c(-25, 25)) + # 'zoom in'
labs(
x = "Target Depth In Yards Thrown Beyond The Line Of Scrimmage (DOT)",
y = "Completion Percentage Over Expectation (CPOE in percentage points)",
caption = "Data: @nflfastR",
title = glue::glue("Passing Efficiency {season}"),
subtitle = "CPOE as a function of target depth. Dotsize equivalent to number of targets. Smoothed for -10 ≤ DOT ≤ 40 Yards. Red Line = League Average."
) +
theme_bw() +
theme(
axis.title = element_text(size = 10),
axis.text = element_text(size = 6),
plot.title = element_text(size = 12, hjust = 0.5, face = "bold"),
plot.subtitle = element_text(size = 10, hjust = 0.5),
plot.caption = element_text(size = 8),
legend.title = element_text(size = 8),
legend.text = element_text(size = 6),
strip.text = element_text(size = 6, hjust = 0.5, face = "bold"),
aspect.ratio = 1 / asp
) +
facet_wrap(vars(name), ncol = 6, scales = "free")
asp <- 1.2
summary %>%
ggplot(aes(x = air_yards, y = cpoe)) +
geom_smooth(
data = mean, aes(x = air_yards, y = league, weight = league_count), n = n_eval,
color = "red", alpha = 0.7, se = FALSE, size = 0.5, linetype = "dashed"
) +
geom_smooth(
se = FALSE, alpha = 0.7, aes(weight = count), size = 0.65,
color = colors$team_color, n = n_eval
) +
geom_point(color = summary$team_color, size = summary$count / 15, alpha = 0.4) +
ggimage::geom_image(aes(x = 27.5, y = -20, image = team_logo_espn),
size = .15, by = "width", asp = asp
) +
ggimage::geom_image(aes(x = -2.5, y = -20, image = teamPlayers.headshot_url),
size = .15, by = "width", asp = asp
) +
xlim(-10, 40) + # makes sure the smoothing algorithm is evaluated between -10 and 40
coord_cartesian(xlim = c(-5, 30), ylim = c(-25, 25)) + # 'zoom in'
labs(
x = "Target Depth In Yards Thrown Beyond The Line Of Scrimmage (DOT)",
y = "Completion Percentage Over Expectation (CPOE in percentage points)",
caption = "Data: @nflfastR",
title = glue::glue("Passing Efficiency {season}"),
subtitle = "CPOE as a function of target depth. Dotsize equivalent to number of targets. Smoothed for -10 ≤ DOT ≤ 40 Yards. Red Line = League Average."
) +
theme_bw() +
theme(
axis.title = element_text(size = 10),
axis.text = element_text(size = 6),
plot.title = element_text(size = 12, hjust = 0.5, face = "bold"),
plot.subtitle = element_text(size = 10, hjust = 0.5),
plot.caption = element_text(size = 8),
legend.title = element_text(size = 8),
legend.text = element_text(size = 6),
strip.text = element_text(size = 6, hjust = 0.5, face = "bold"),
aspect.ratio = 1 / asp
) +
facet_wrap(vars(name), ncol = 6, scales = "free")
summary
summary %>%
ggplot(aes(x = air_yards, y = cpoe)) +
geom_smooth(
data = mean, aes(x = air_yards, y = league, weight = league_count), n = n_eval,
color = "red", alpha = 0.7, se = FALSE, size = 0.5, linetype = "dashed"
) +
geom_smooth(
se = FALSE, alpha = 0.7, aes(weight = count), size = 0.65,
color = colors$team_color, n = n_eval
) +
geom_point(color = summary$team_color, size = summary$count / 15, alpha = 0.4) +
ggimage::geom_image(aes(x = 27.5, y = -20, image = team_logo_espn),
size = .15, by = "width", asp = asp
) +
ggimage::geom_image(aes(x = -2.5, y = -20, image = teamPlayers.headshot_url),
size = .15, by = "width", asp = asp
) +
xlim(-10, 40) + # makes sure the smoothing algorithm is evaluated between -10 and 40
coord_cartesian(xlim = c(-5, 30), ylim = c(-25, 25)) + # 'zoom in'
labs(
x = "Target Depth In Yards Thrown Beyond The Line Of Scrimmage (DOT)",
y = "Completion Percentage Over Expectation (CPOE in percentage points)",
caption = "Data: @nflfastR",
title = glue::glue("Passing Efficiency 2021"),
subtitle = "CPOE as a function of target depth. Dotsize equivalent to number of targets. Smoothed for -10 ≤ DOT ≤ 40 Yards. Red Line = League Average."
) +
theme_bw() +
theme(
axis.title = element_text(size = 10),
axis.text = element_text(size = 6),
plot.title = element_text(size = 12, hjust = 0.5, face = "bold"),
plot.subtitle = element_text(size = 10, hjust = 0.5),
plot.caption = element_text(size = 8),
legend.title = element_text(size = 8),
legend.text = element_text(size = 6),
strip.text = element_text(size = 6, hjust = 0.5, face = "bold"),
aspect.ratio = 1 / asp
) +
facet_wrap(vars(name), ncol = 6, scales = "free")
summary
summary %>%
ggplot(aes(x = air_yards, y = cpoe)) +
geom_smooth(
data = mean, aes(x = air_yards, y = league, weight = league_count), n = n_eval,
color = "red", alpha = 0.7, se = FALSE, size = 0.5, linetype = "dashed"
) +
geom_smooth(
se = FALSE, alpha = 0.7, aes(weight = count), size = 0.65,
color = colors$team_color, n = n_eval
) +
geom_point(color = summary$team_color, size = summary$count / 15, alpha = 0.4) +
ggimage::geom_image(aes(x = 27.5, y = -20, image = team_logo_espn),
size = .15, by = "width", asp = asp
) +
ggimage::geom_image(aes(x = -2.5, y = -20, image = headshot_url),
size = .15, by = "width", asp = asp
) +
xlim(-10, 40) + # makes sure the smoothing algorithm is evaluated between -10 and 40
coord_cartesian(xlim = c(-5, 30), ylim = c(-25, 25)) + # 'zoom in'
labs(
x = "Target Depth In Yards Thrown Beyond The Line Of Scrimmage (DOT)",
y = "Completion Percentage Over Expectation (CPOE in percentage points)",
caption = "Data: @nflfastR",
title = glue::glue("Passing Efficiency 2021"),
subtitle = "CPOE as a function of target depth. Dotsize equivalent to number of targets. Smoothed for -10 ≤ DOT ≤ 40 Yards. Red Line = League Average."
) +
theme_bw() +
theme(
axis.title = element_text(size = 10),
axis.text = element_text(size = 6),
plot.title = element_text(size = 12, hjust = 0.5, face = "bold"),
plot.subtitle = element_text(size = 10, hjust = 0.5),
plot.caption = element_text(size = 8),
legend.title = element_text(size = 8),
legend.text = element_text(size = 6),
strip.text = element_text(size = 6, hjust = 0.5, face = "bold"),
aspect.ratio = 1 / asp
) +
facet_wrap(vars(full_name), ncol = 6, scales = "free")
p1 <- summary %>%
ggplot(aes(x = air_yards, y = cpoe)) +
geom_smooth(
data = mean, aes(x = air_yards, y = league, weight = league_count), n = n_eval,
color = "red", alpha = 0.7, se = FALSE, size = 0.5, linetype = "dashed"
) +
geom_smooth(
se = FALSE, alpha = 0.7, aes(weight = count), size = 0.65,
color = colors$team_color, n = n_eval
) +
geom_point(color = summary$team_color, size = summary$count / 15, alpha = 0.4) +
ggimage::geom_image(aes(x = 27.5, y = -20, image = team_logo_espn),
size = .15, by = "width", asp = asp
) +
ggimage::geom_image(aes(x = -2.5, y = -20, image = headshot_url),
size = .15, by = "width", asp = asp
) +
xlim(-10, 40) + # makes sure the smoothing algorithm is evaluated between -10 and 40
coord_cartesian(xlim = c(-5, 30), ylim = c(-25, 25)) + # 'zoom in'
labs(
x = "Target Depth In Yards Thrown Beyond The Line Of Scrimmage (DOT)",
y = "Completion Percentage Over Expectation (CPOE in percentage points)",
caption = "Data: @nflfastR",
title = glue::glue("Passing Efficiency 2021"),
subtitle = "CPOE as a function of target depth. Dotsize equivalent to number of targets. Smoothed for -10 ≤ DOT ≤ 40 Yards. Red Line = League Average."
) +
theme_bw() +
theme(
axis.title = element_text(size = 10),
axis.text = element_text(size = 6),
plot.title = element_text(size = 12, hjust = 0.5, face = "bold"),
plot.subtitle = element_text(size = 10, hjust = 0.5),
plot.caption = element_text(size = 8),
legend.title = element_text(size = 8),
legend.text = element_text(size = 6),
strip.text = element_text(size = 6, hjust = 0.5, face = "bold"),
aspect.ratio = 1 / asp
) +
facet_wrap(vars(full_name), ncol = 6, scales = "free")
ggsave(p1, path = "plots", filename = "qb_adot_cpoe.png", dpi = 600)
p1 <- summary %>%
ggplot(aes(x = air_yards, y = cpoe)) +
geom_smooth(
data = mean, aes(x = air_yards, y = league, weight = league_count), n = n_eval,
color = "red", alpha = 0.7, se = FALSE, size = 0.5, linetype = "dashed"
) +
geom_smooth(
se = FALSE, alpha = 0.7, aes(weight = count), size = 0.65,
color = colors$team_color, n = n_eval
) +
geom_point(color = summary$team_color, size = summary$count / 15, alpha = 0.4) +
ggimage::geom_image(aes(x = 27.5, y = -20, image = team_logo_espn),
size = .15, by = "width", asp = asp
) +
ggimage::geom_image(aes(x = -2.5, y = -20, image = headshot_url),
size = .15, by = "width", asp = asp
) +
xlim(-10, 40) + # makes sure the smoothing algorithm is evaluated between -10 and 40
coord_cartesian(xlim = c(-5, 30), ylim = c(-25, 25)) + # 'zoom in'
labs(
x = "Target Depth In Yards Thrown Beyond The Line Of Scrimmage (DOT)",
y = "Completion Percentage Over Expectation (CPOE in percentage points)",
caption = "Data: @nflfastR",
title = glue::glue("Passing Efficiency 2021"),
subtitle = "CPOE as a function of target depth. Dotsize equivalent to number of targets. \nSmoothed for -10 ≤ DOT ≤ 40 Yards. Red Line = League Average."
) +
theme_bw() +
theme(
axis.title = element_text(size = 10),
axis.text = element_text(size = 6),
plot.title = element_text(size = 12, hjust = 0.5, face = "bold"),
plot.subtitle = element_text(size = 10, hjust = 0.5),
plot.caption = element_text(size = 8),
legend.title = element_text(size = 8),
legend.text = element_text(size = 6),
strip.text = element_text(size = 6, hjust = 0.5, face = "bold"),
aspect.ratio = 1 / asp
) +
facet_wrap(vars(full_name), ncol = 6, scales = "free")
ggsave(p1, path = "plots", filename = "qb_adot_cpoe1.png", dpi = 600)
p1 <- summary %>%
ggplot(aes(x = air_yards, y = cpoe)) +
geom_smooth(
data = mean, aes(x = air_yards, y = league, weight = league_count), n = n_eval,
color = "red", alpha = 0.7, se = FALSE, size = 0.5, linetype = "dashed"
) +
geom_smooth(
se = FALSE, alpha = 0.7, aes(weight = count), size = 0.65,
color = colors$team_color, n = n_eval
) +
geom_point(color = summary$team_color, size = summary$count / 15, alpha = 0.4) +
ggimage::geom_image(aes(x = 27.5, y = -20, image = team_logo_espn),
size = .15, by = "width", asp = asp
) +
ggimage::geom_image(aes(x = -2.5, y = -20, image = headshot_url),
size = .15, by = "width", asp = asp
) +
xlim(-10, 40) + # makes sure the smoothing algorithm is evaluated between -10 and 40
coord_cartesian(xlim = c(-5, 30), ylim = c(-25, 25)) + # 'zoom in'
labs(
x = "Target Depth In Yards Thrown Beyond The Line Of Scrimmage (DOT)",
y = "Completion Percentage Over Expectation (CPOE in percentage points)",
caption = "Data: @nflfastR",
title = glue::glue("Passing Efficiency 2021"),
subtitle = "CPOE as a function of target depth. Dotsize equivalent to number of targets. \nSmoothed for -10 ≤ DOT ≤ 40 Yards. \nRed Line = League Average."
) +
theme_bw() +
theme(
axis.title = element_text(size = 10),
axis.text = element_text(size = 6),
plot.title = element_text(size = 12, hjust = 0.5, face = "bold"),
plot.subtitle = element_text(size = 10, hjust = 0.5),
plot.caption = element_text(size = 8),
legend.title = element_text(size = 8),
legend.text = element_text(size = 6),
strip.text = element_text(size = 6, hjust = 0.5, face = "bold"),
aspect.ratio = 1 / asp
) +
facet_wrap(vars(full_name), ncol = 6, scales = "free")
ggsave(p1, path = "plots", filename = "qb_adot_cpoe2.png", dpi = 600)
library(ggthemes)
library(ggrepel)
pbp_all <- purrr::map_df(c(2021), function(x) {
readRDS(
glue::glue("~/Documents/nfl/data/pbp/play_by_play_{x}.rds")
)
})
# since we want to work with the players GSIS-ID we load some rosterdata from ron
roster <- purrr::map_df(c(2021), function(x) {
readRDS(
glue::glue("~/Documents/nfl/data/roster/roster_{x}.rds")
)
})
chart <- pbp_all %>%
filter(pass==1 & play==1 & !is.na(receiver_player_id) & !play_type=="note" & special==0 & !is.na(air_yards)) %>%
group_by(receiver_player_id) %>%
summarise(
tar=n(),
adot=mean(air_yards),
name=first(receiver_player_name)
) %>%
left_join(roster
%>% select(full_name, gsis_id, position, team),
by = c("receiver_player_id"="gsis_id")) %>%
filter(tar>=30 & position=="RB") %>%
arrange(desc(tar)) %>%
left_join(nflfastR::teams_colors_logos, by = c("team" = "team_abbr"))
chart %>%
ggplot(aes(x = tar, y = adot)) +
geom_hline(aes(yintercept = mean(adot)), color = "red", linetype = "dashed") +
geom_vline(aes(xintercept = mean(tar)), color = "red", linetype = "dashed") +
geom_point(colour = chart$team_color, fill = chart$team_color, alpha = 0.4, cex = 5) +
geom_text_repel(aes(label = glue("{name} ({team})")), force = 1, point.padding = 0, segment.size = 0.1) +
labs(x = "Targets",
y = "Average Depth of Target - aDOT",
caption = "Data: @nflscrapR",
title = 'Receiving Performance by Running Backs in 2019',
subtitle = "Number of Targets and Average Depth of Target for RBs with more than 30 Targets"
)+
theme_stata() +
theme(axis.title = element_text(size = 10),
axis.text = element_text(size = 10),
plot.title = element_text(size = 14, hjust = 0.5, face = 'bold'),
plot.subtitle = element_text(size = 12, hjust = 0.5),
plot.caption = element_text(size = 10, hjust = 1))
p1 <- chart %>%
ggplot(aes(x = tar, y = adot)) +
geom_hline(aes(yintercept = mean(adot)), color = "red", linetype = "dashed") +
geom_vline(aes(xintercept = mean(tar)), color = "red", linetype = "dashed") +
geom_point(colour = chart$team_color, fill = chart$team_color, alpha = 0.4, cex = 5) +
geom_text_repel(aes(label = glue("{name} ({team})")), force = 1, point.padding = 0, segment.size = 0.1) +
labs(x = "Targets",
y = "Average Depth of Target - aDOT",
caption = "Data: @nflscrapR",
title = 'Receiving Performance by Running Backs in 2019',
subtitle = "Number of Targets and Average Depth of Target for RBs with more than 30 Targets"
)+
theme_stata() +
theme(axis.title = element_text(size = 10),
axis.text = element_text(size = 10),
plot.title = element_text(size = 14, hjust = 0.5, face = 'bold'),
plot.subtitle = element_text(size = 12, hjust = 0.5),
plot.caption = element_text(size = 10, hjust = 1))
ggsave(p1, path = "plots", filename = "rb_rec_adot_target.png", dpi = 600)
